.. comment: -*- mode:rst;coding:utf-8 -*-

ABNotation Design Notes
################################################################################


SpÃ©cifications
================================================================================


Principales fonctionalitÃ©s

- lecture d'une sÃ©quence Midi reprÃ©sentant un morceau de musique.

- affichage de la partition correspondante selon la notation AB en mode prÃ©visualisation.

- impression de la partition (sur feuilles A4 ou A3).

- affichage de la sÃ©quence Midi sous forme textuelle comme liste de
  nombres/valeurs : (hauteur duration (h1 h2â€¦) duration â€¦).

- l'utilisateur peut ajuster la mise en page de la partition.

- l'utilisateur peut Ã©diter la partition, en particulier:

    - transposition d'une note ou d'un groupe de notes.

Actions
--------------------------------------------------------------------------------

- load a MIDI file [menu, (drag-and-drop midi-file)]
- export a MIDI file [menu]
- load an abnotation partition file [menu, (drag-and-drop midi-file)]
- save an abnotation partition file [menu]
  



- sÃ©lections [graphique (simple clic, shift-click, command-click), & bindings]
  + annotation (texte ou image)
  + note
    * head
    * accidental
    * beam
    * dynamic
    * tenue
  + cluster
    idem note
  + measure
  + line
  + page
  + partition

- sur la partitions (paramÃ¨tres globaux):
  + changement de la taille du papier et orientation. [menu]
  + changement de la hauteur des portÃ©es (3 mm, 5 mm, 7 mm). [menu]
  + changement du nombre de portÃ©es par ligne et clefs. [menu]
  + changement de la police des numÃ©ros de page. [menu]
  + changement de la police des numÃ©ros de ligne. [menu]
  + changement de la police des numÃ©ros de mesure. [menu]
  + Ã©dition des mÃ©tadonnÃ©es (titre, auteur, annotation).

- sur l'objet sÃ©lectionnÃ©:
  + ajout d'une annotation (image ou texte) (tous sauf annotations elles mÃªmes) [menu].
  + suppression de l'annotation [menu].
  + ajustement de la position (line, ledger, staff, clef, sound, beam,
    dynamic, tenue, head, accidental, annotation) [click-and-drag, ou saisie offset (+/-9.99 mm)]
  + cut de l'objet [menu].
  + copy de l'objet [menu].
  + delete de l'objet [menu].
  + paste of an object -> insertion [menu].
  + paste of an image or text -> add/replace the annotation [menu].

- sur measure(s) sÃ©lectionnÃ©e(s):
  + ajustement de la largeur (measure) [click-and-drag on corner, ou saisie durÃ©e (9.99 s)].
  + changement du tempo second/measure (ajustement de la largeur automatique).
  + ajustement de la position du numÃ©ro.

- Ã©dition de notes:

  + click-and-drag on the head to change the pitch and start of the
    note. (if multiple selection, transpose or offset all the
    selection). This may add or remove accidentals.

  + click-and-drag on the right part of the beam to change the duration of the note.
    (variation to shift the following notes or not). This may add or remove a tenue.

  + add a dynamic [popup-menu]

  + click-and-drag on the dynamic to change it.

- insertion d'une page
- insertion d'une ligne
- insertiotn d'une mesure
- insertion d'une note (en cluster ou en sÃ©quence)

- selection of an image annotation
- cut/copy/paste/delete of the image annotation
- selection of a text annotation
- edition of rich text annotation (font).


Other features
--------------------------------------------------------------------------------

- get a histogram of the dynamics
- specify the ranges for the various dynamics annotations: ğ†ğ†ğ† ğ†ğ† ğ† ğ†ğ†‘ ğ†ğ†‘ ğ†‘ ğ†‘ğ†‘ ğ†‘ğ†‘ğ†‘
- selection of digits or letters to annotate the dynamics.
- identification of ranges of monotone dynamics changes.   ğ†’   ğ†“

- representation of the partition as an editable, textual, lispy structure.



Bindings
--------------------------------------------------------------------------------

    â†’ â†   C-f/C-b forward/backward note/cluster
    âŒ˜â†’ âŒ˜â† M-f/M-b forward/backward measure
    â†“ â†‘     C-n/C-p forward/backward line
    âŒ˜â†“ âŒ˜â†‘   C-v/M-v forward/backward page

    â‡§â†’ â‡§â†   S-C-f/S-C-b selecting forward/backward note/cluster
    â‡§âŒ˜â†’ â‡§âŒ˜â† S-M-f/S-M-b selecting forward/backward measure
    â‡§â†“ â‡§â†‘     S-C-n/S-C-p selecting forward/backward line
    â‡§âŒ˜â†“ â‡§âŒ˜â†‘   S-C-v/S-M-v selecting forward/backward page


âŒ˜ â€“ &#x2318; â€“ &#8984; â€“ the Command Key symbol
âŒ¥ â€“ &#x2325; â€“ &#8997; â€“ the Option Key symbol
â‡§ â€“ &#x21E7; â€“ &#8679; â€“ the Shift Key symbol
â‹ â€“ &#x238B; â€“ &#9099; â€“ the ESC Key symbol
â‡ª â€“ &#x21ea; â€“ &#8682; â€“ the Capslock symbol
â â€“ &#x23ce; â€“ &#9166; â€“ the Return symbol
âŒ« â€“ &#x232b; â€“ &#9003; â€“ the Delete / Backspace symbol


Model
--------------------------------------------------------------------------------


                     element 1------------------o annotation
                        ^                             ^                             
                        |                             |
                        |                     +-------+--------+
     +------------------|----* tempo 1----+   |                |
     |                  |                 | image             text
     |  +------------+--+-----+---------+ |
     |  |            |        |         | *
    partition 1--* page 1--* line 1--* measure 1---* sound
                              | \                      ^
                              *  *                     |
                          staff  ledger        +-------+-------+
                          |   o    o           |               |
                          |   |    |           |               |
                        clef  +----========* note *-------o cluster


Midi Reader
================================================================================

TODO: see multi-track.

midi track -> sequence of CLUSTER-*note | rest

note-on (channel note velocityâ‰ 0)
note-off (channel note velocity), or note-on (channel note velocity=0)
polyphonic-aftertouch (channel note pressure)
program-change (channel program-number)
channel-aftertouch (channel pressure)
pitch-wheel-change (channel value)
control/mode-change


note-on / note-off --> sequence of (cluster-*note | rest)

velocity changes   --> ğ†’   ğ†“

velocity intervals -->  ğ†ğ†ğ† ğ†ğ† ğ†  ğ†ğ†‘  ğ†ğ†‘  ğ†‘  ğ†‘ğ†‘  ğ†‘ğ†‘ğ†‘        ğ†’   ğ†“
                         1  2  3  4   5  6  7  8      si progression
                                                     linÃ©aire dÃ©tectÃ©e

polyphonic-aftertouch ) --> <>  ğ†’   ğ†“ ; or ~~~?
channel-aftertouch    )

pitch-wheel-change --> ~~~ or some other?  eg. ğ„³ ğ„² ğ„± ğ„° ğ„¯ ğ„® ğ„­ ğ„¬ ğ„« 






gsharp note pitch is (integer 0 127)

- accidentals (member :natural :flat :double-flat :sharp :double-sharp)

gsharp note durations are defined as:

- head (or null (member :long :breve :whole :half :filled))

- dots (or null (integer 0 3))

Notice: gsharp note is subclass of gsharp-objects, not of
        melodic-element or rhythmic-element.  A note is inside a
        cluster, which is a melodic-element which is a
        rhythmic-element.


 +----------+-------------------+-----------+---------------+---------------------+
 | English  | French            | duration  | rest          | notehead            |
 +==========+===================+===========+===============+=====================+
 |  :maxima |                   | 8         |               |                     |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :long   | longue            | 4         | :long-rest    | :breve-notehead     |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :breve  | carrÃ©e            | 2         | :breve-rest   | :breve-notehead     |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :whole  | ronde             | 1         | :whole-rest   | :whole-notehead     |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :half   | blanche           | 1/2       | :half-rest    | :half-notehead      |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :filled | noire             | 1/4       | :quarter-rest | :filled-notehead    |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :8th    | croche            | 1/8       | :8th-rest     | :filled-notehead    |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :16th   | double-croche     | 1/16      | :16th-rest    | :filled-notehead    |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :32th   | triple-croche     | 1/32      | :32nd-rest    | :filled-notehead    |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :64th   | quadruple-croche  | 1/64      | :64th-rest    | :filled-notehead    |
 +----------+-------------------+-----------+---------------+---------------------+
 |  :128th  | quintuple-croche  | 1/128     |               |                     |
 +----------+-------------------+-----------+---------------+---------------------+



We should define our own class of notes or cluster (as subclass of
gsharp:cluster).

AB notation notes should be defined as pitch/duration/force.

The duration is defined on the superclass rhythmic-element.
(undotted-duration rhythmic-element)
(duration rhythmic-element)

We can override those methods to have specific durations.


        
Notation AB
================================================================================


Ã‰lÃ©ments graphiques:

- NumÃ©ro de page en haut Ã  gauche dans un cercle (de 1 Ã  N).
- NumÃ©ro de systÃ¨me de portÃ©es dans la page Ã  gauche de la premiÃ¨re portÃ©e dans un carrÃ© (de 1 Ã  N).
- NumÃ©ro de mesure dans la portÃ©e au dessus de la marque de dÃ©but de mesure (de 1 Ã  N).



Impression

- Mise en page en format A4 ou A5, paysage ou portrait.




- option: variation de longueur des mesures pour une mÃªme durÃ©e de
  rÃ©fÃ©rence.



- RÃ©glage longueur mesure: ::

        1      2      3      4      5
        â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”

  1. par dÃ©faut, minimum selon M = ğ…Ÿâ™¯ğ…Ÿ (note dieze note) = 6/100 seconde

  2. longueur des mesures:

     a. durÃ©e de mesure en x 1/100 seconde (minimum 6/100 seconde) ::

            si < M  alors
               soit mesure(s) affectÃ©e(s) rallongÃ©es en fonction de M,
               soit toutes les mesures rallongÃ©es en fonction de M,
            sinon longueurs identiques

     b. facultatif: rÃ©glage de la longueur de toutes les mesures en mm
        (sur page imprimÃ©e) ou par ajustement graphiqe d'une mesure
        quelconque, longueur d'une ou de plusieurs mesures
        sÃ©lectionneÃ©es en mm ou par ajustement graphique.

- Pour tous les rÃ©glages d'espace: soit en mm, soit par ajustement
  graphique d'un Ã©lÃ©ment sÃ©lectionnÃ© (ou ensemble d'Ã©lÃ©ments)
  affectant l'ensemble, ou l'Ã©lÃ©ment sÃ©lectionnÃ©.

- RÃ©glage des tailles et polices des chiffres

- Insertion texte et image

- choix du nombre de portÃ©es par ligne, avec les clefs: (ğ„ ğ„¢ ğ„ğ„¢ ğ„ğ„¸ğ„ğ„¢ ğ„ğ„¢ğ„¢ğ„¹ ğ„ğ„¸ğ„ğ„¢ğ„¢ğ„¹)
  (sol fa sol+fa sol15ma+sol+fa sol+fa+fa15mb sol15ma+sol+fa+fa15mb)  ::
   122                    re                           \        ledger.maximum
   121                 --do--                9          |       ledger.top
   119                  si                              | 
   117               --la--                            /        ledger.minimum = ledger.bottom                 
   115     15         sol                    8                     \     staff.maximum 
   113  -------------fa-------------------------                    |    staff.top     
   112              mi                                              |
   110  -----------re---------------------------                    |
   108            do                         8                      |
   107  ---------si-----------------------------                    |
   105          la                                                  |
   103  ---o--sol----------------------------7-- clÃ© de sol15ma     |
   101          fa                                                  |
   100  ---------mi-----------------------------                    |    staff.bottom  
    98            re                                               /     staff.minimum
    96           --do--                      7          \ ledger.maximum = ledger.top  
    95              si                                   |                           
    93             --la--                                / ledger.minumum = ledger.bottom
    91                sol                    6            
    89  -------------fa-------------------------
    88              mi   
    86  -----------re---------------------------
    84            do                         6
    83  ---------si-----------------------------
    81          la                              
    79  ---o--sol--- ------------------------5-- clÃ© de sol
    77          fa                              
    76  ---------mi-----------------------------           
    74            re                            
    72           --do--                      5  
    71          si                              
    69  -------la-------------------------------
    67        sol                            4 
    65  ---)-fa--------------------------------- clÃ© de fa
    64        mi                              
    62  -------re-------------------------------
    60          do                           4
    59  ---------si-----------------------------
    57            la    
    55  -----------sol-----------------------3--
    53               fa  
    52            --mi--                                      
    50             re                            
    48          --do--                       3      
    47          si                              
    45  -------la-------------------------------
    43        sol                            2  
    41  ---)-fa--------------------------------- clÃ© de fa15mb
    40        mi                              
    38  -------re-------------------------------
    36          do                           2
    35  ---------si-----------------------------
    33            la    
    31  -----------sol--------------------------
    29      15      fa  
    28             --mi--                             \
    26                re                               |
    24               --do--                  1         |
    23                  si                            /

            
    a0 = 21
    c1 = 24
    c8 = 108
    c9 = 128


- hauteur d'une portÃ©e: 3, 5 ou 7 mm (imprimÃ©e).

- le dÃ©but temporel d'une note est dÃ©notÃ© par la bordure gauche de la hampe.

- armature: â™¯ pour do et fa, â™­ pour les autres; pas de â™® bÃ©care.
  Mais option pour: â™­ğ…Ÿâ™®ğ…Ÿ  ou  â™¯ğ…Ÿâ™®ğ…Ÿ

- dans le cas de modificateurs prÃ©fixes sur la premiÃ¨re note d'une
  mesure, ces modificateurs peuvent dÃ©border sur la mesure prÃ©cÃ©dente.
  Si nÃ©cessaire, alonger la mesure prÃ©cÃ©dente.


- intensitÃ©s: symboles avec choix entre continu ou discontinu: ::

        ğ†ğ†ğ† ğ†ğ† ğ†  ğ†ğ†‘  ğ†ğ†‘  ğ†‘  ğ†‘ğ†‘  ğ†‘ğ†‘ğ†‘        ğ†’   ğ†“
        1  2  3  4   5  6  7  8      si progression
                                    linÃ©aire dÃ©tectÃ©e

  Quand l'intensitÃ© ne change pas, pas de signe.

- polyphonie: notation des agrÃ©gats par cluster.

- notation d'une note ou ensemble de notes se prolongeant au delÃ  des
  suivantes.  PremiÃ¨re note tenue : ::

        ğ…Ÿ  ğ…Ÿ   ğ…Ÿ
        â”” â”€ â”€ â”€ â”˜

  toutes les notes tenues : ::

        ğ…Ÿ  ğ…Ÿ   ğ…Ÿ
        â””â”€â”€â”€â”€â”€â”€â”€â”˜



.. comment
    (coerce (mapcar 'cdr (remove-if-not (lambda (x) (prefixp "MUSICAL" (car x))) (ucs-names)))
            'string)

      "ğŸ¼ğŸ¹ğŸµğ‡ğ‡œğ‡›ğ‡šğ‡™ğ‡˜ğ‡—ğ‡–ğ‡•ğ‡”ğ‡“ğ‡’ğ‡‘ğ‡ğ‡ğ‡ğ‡ğ‡Œğ‡‹ğ‡Šğ‡‰ğ‡ˆğ‡‡ğ‡†ğ‡…ğ‡„ğ‡ƒğ‡‚ğ‡ğ‡€ğ†¿ğ†¾ğ†½ğ†¼ğ†»ğ†ºğ†¹ğ†¸ğ†·ğ†¶ğ†µğ†´ğ†³ğ†²ğ†±ğ†°ğ†¯ğ†®ğ†­ğ†¬ğ†«ğ†ªğ†©ğ†¨ğ†§ğ†¦ğ†¥ğ†¤ğ†£ğ†¢ğ†¡ğ† ğ†Ÿğ†ğ†ğ†œğ†›ğ†šğ†™ğ†˜ğ†—ğ†–ğ†•ğ†”ğ†“ğ†’ğ†‘ğ†ğ†ğ†ğ†ğ†Œğ†‹ğ†Šğ†‰ğ†ˆğ†‡ğ††ğ†…ğ†„ğ†ƒğ†‚ğ†ğ†€ğ…¿ğ…¾ğ…½ğ…¼ğ…»ğ…ºğ…¹ğ…¸ğ…·ğ…¶ğ…µğ…´ğ…³ğ…²ğ…±ğ…°ğ…¯ğ…®ğ…­ğ…¬ğ…«ğ…ªğ…©ğ…¨ğ…§ğ…¦ğ…¥ğ…¤ğ…£ğ…¢ğ…¡ğ… ğ…Ÿğ…ğ…ğ…œğ…›ğ…šğ…™ğ…˜ğ…—ğ…–ğ…•ğ…”ğ…“ğ…’ğ…‘ğ…ğ…ğ…ğ…ğ…Œğ…‹ğ…Šğ…‰ğ…ˆğ…‡ğ…†ğ……ğ…„ğ…ƒğ…‚ğ…ğ…€ğ„¿ğ„¾ğ„½ğ„¼ğ„»ğ„ºğ„¹ğ„¸ğ„·ğ„¶ğ„µğ„´ğ„³ğ„²ğ„±ğ„°ğ„¯ğ„®ğ„­ğ„¬ğ„«ğ„ªğ„©ğ„¦ğ„¥ğ„¤ğ„£ğ„¢ğ„¡ğ„ ğ„Ÿğ„ğ„ğ„œğ„›ğ„šğ„™ğ„˜ğ„—ğ„–ğ„•ğ„”ğ„“ğ„’ğ„‘ğ„ğ„ğ„ğ„ğ„Œğ„‹ğ„Šğ„‰ğ„ˆğ„‡ğ„†ğ„…ğ„„ğ„ƒğ„‚ğ„ğ„€"

Architecture
================================================================================


A set of model class to represent the partition in an abstract way.

A set of abstract graphic objects to compute the partition layout.

The user interface us implemented separately in Cocoa or iOS or
anything else, independently of the model and abstract graphic
objects.

Reading MIDI files produces a sequence of sound (cluster or note) with tempo.

Given the partition parameters (paper size, orientation, font sizes),
and the sequence of sounds/tempo,  layout objects are created to
compute a layout and structure the notes into measures, lines and
pages.

While editing:

- adding a page doesn't change the layout of the following pages
  (until the lines are let flown back).

- adding a line doesn't change the layout of the following lines (only
  the layout of the following pages with respect to their lines),
  until the measures are left flown back.

- adding a measure doesn't change the layout of the following layouts
  (only the layout of the following lines with respect to their
  measures), until the notes are left flown back.

- adding a note can be done either without moving the following notes,
  or moving the following notes ("inserting" the note).

At each level, we can have an automatic layout lock, that prevents
recomputing the following layouts, until it's unlocked.  Note: only
one page is visible, so objects (measures, lines) can overflow a page
without having to recompute the layout of all the following pages,
until we unlock the layout.





ABNotation Schematic class diagram
================================================================================

Model
--------------------------------------------------------------------------------


                     element 1------------------o annotation
                        ^                             ^                             
                        |                             |
                        |                     +-------+--------+
     +------------------|----* tempo 1----+   |                |
     |                  |                 | image             text
     |  +------------+--+-----+---------+ |
     |  |            |        |         | *
    partition 1--* page 1--* line 1--* measure 1---* sound
                              | \                      ^
                              *  *                     |
                          staff  ledger        +-------+-------+
                          |   o    o           |               |
                          |   |    |           |               |
                        clef  +----========* note *-------o cluster
                                                




Gsharp Schematic class diagram
================================================================================

::


                                                                       key-signature
                                                                            |
                                    +-----------------------------1 clef    |         time-signature
                                    |                                |      |               |
                                    |                                +------+---------------+
                                    |                                       |
                                    |                                       v
                         fiveline-staff 1--------------------------* staffwise-element
                               |                                            |
                               v                                            |
       +-------------------* staff                                          |
       |                       *                                            |
       |                       |                                            v
    buffer 1--* segment 1--* layer 1--3 slice 1--* bar 1---------------* element
                               |                    |                      ^
                               |                    |                      |
                               |                    |               rhythmic-element
                               |                    |                      ^
                               |                    |                      |
                          melody-layer         melody-bar             melody-element
                                                                           ^
                                                                           |
                                                                           +-----------+
                                                                           |           |
                                                                        cluster       rest
                                                                           |
                                                                           *
                                                                          note
                                                                              
                                                                              
              tuning                                                          
                ^                                                             
                |                                                             
                +---------+                                                   
                |         |                                                   
              12-edo   regular-temperament                                    
                                                                              


.. comment:
   ---------------------------------------------------------------
                            -------------
                                  -
                                  .
